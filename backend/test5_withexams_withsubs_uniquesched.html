<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SchedSync | Admin Dashboard</title>
  <style>
    :root {
      --bg: #f5f5f5;
      --text: #111827;
      --card: #ffffff;
      --sidebar: #111827;
      --link: #ffffff;
      --link-hover: #60a5fa;
      --link-active: #60a5fa;
      --table-header: #e5e7eb;
      --table-border: #ddd;
    }
    [data-theme="dark"] {
      --bg: #0f1014;
      --text: #e5e7eb;
      --card: #1a1c22;
      --sidebar: #0b0c10;
      --link: #d1d5db;
      --link-hover: #60a5fa;
      --link-active: #60a5fa;
      --table-header: #1f2937;
      --table-border: #374151;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }

    body {
      display: flex;
      height: 100vh;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
    }

    .sidebar {
      width: 240px;
      background: var(--sidebar);
      color: var(--link);
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 100vh;
    }
    .sidebar-content { flex: 1; }
    .sidebar h2 { font-size: 22px; margin-bottom: 20px; font-weight: bold; color: var(--link); }
    .sidebar a {
      display: block;
      color: var(--link);
      text-decoration: none;
      padding: 10px 0;
      margin: 5px 0;
      font-size: 16px;
      cursor: pointer;
      transition: color 0.3s;
    }
    .sidebar a:hover { color: var(--link-hover); }
    .sidebar a.active { color: var(--link-active); font-weight: bold; }

    .toggle-container {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
      margin-bottom: 20px;
      cursor: pointer;
    }
    .toggle-container input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #d1d5db;
      border-radius: 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 6px;
      transition: background 0.35s ease;
    }
    .toggle-slider .icon { font-size: 16px; opacity: 0.35; transition: opacity 0.35s ease; }
    .toggle-slider .sun { color: #facc15; }
    .toggle-slider .moon { color: #1f2937; }

    [data-theme="dark"] .toggle-slider .sun { color: #facc15; }
    [data-theme="dark"] .toggle-slider .moon { color: #9ca3af; }
    [data-theme="light"] .toggle-slider .sun { color: #9ca3af; }
    [data-theme="light"] .toggle-slider .moon { color: #1f2937; }
    
    .toggle-knob {
      position: absolute;
      top: 3px; left: 3px;
      width: 24px; height: 24px;
      background: white;
      border-radius: 50%;
      transition: transform 0.35s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s ease;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
    }
    .toggle-container:hover .toggle-knob {
      box-shadow: 0 0 10px rgba(255,255,255,0.7), 0 0 8px rgba(0,0,0,0.3);
    }
    .toggle-container input:checked + .toggle-slider .toggle-knob {
      transform: translateX(30px);
    }
    .toggle-container input:checked + .toggle-slider { background: #374151; }
    .toggle-container input:not(:checked) + .toggle-slider .sun { opacity: 1; }
    .toggle-container input:not(:checked) + .toggle-slider .moon { opacity: 0.2; }
    .toggle-container input:checked + .toggle-slider .sun { opacity: 0.2; }
    .toggle-container input:checked + .toggle-slider .moon { opacity: 1; }

    .content { flex: 1; padding: 30px; overflow-y: auto; }
    .section { display: none; }
    .section.active { display: block; }
    h1 { margin-bottom: 20px; font-family: 'Inter', sans-serif; font-weight: 600; }

    .card-container { display: flex; gap: 20px; margin-bottom: 30px; }
    .card { background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); width: 250px; transition: background 0.3s, color 0.3s, transform 0.2s; }
    .card:hover { transform: translateY(-3px); }
    .card h3 { font-size: 24px; }
    .card p { margin-top: 5px; color: var(--text); }

    .loading { opacity: 0.6; }
    .error-message {
      background: #fee2e2;
      color: #dc2626;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      border: 1px solid #fecaca;
    }
    .success-message {
      background: #d1fae5;
      color: #065f46;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      border: 1px solid #a7f3d0;
    }
    .warning-message {
      background: #fef3c7;
      color: #92400e;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      border: 1px solid #fde68a;
    }

    [data-theme="dark"] .error-message {
      background: #7f1d1d;
      color: #fecaca;
      border-color: #991b1b;
    }
    [data-theme="dark"] .success-message {
      background: #064e3b;
      color: #a7f3d0;
      border-color: #065f46;
    }
    [data-theme="dark"] .warning-message {
      background: #78350f;
      color: #fde68a;
      border-color: #92400e;
    }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 12px; border-bottom: 1px solid var(--table-border); text-align: left; background: var(--card); transition: background 0.3s, color 0.3s; }
    th { background: var(--table-header); }

    #debug-info {
      background: #e0e7ff;
      color: #3730a3;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    [data-theme="dark"] #debug-info {
      background: #1e1b4b;
      color: #c7d2fe;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text);
      opacity: 0.7;
    }

    /* Styles for class schedules */
    .days-badge {
      display: inline-block;
      background: #3b82f6;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin: 2px;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-content">
      <h2>SchedSync</h2>
      <a onclick="showSection('dashboard', this)">Dashboard</a>
      <a onclick="showSection('users', this)">Users</a>
      <a onclick="showSection('exams', this)">Exams</a>
      <a onclick="showSection('submissions', this)">Submissions</a>
    </div>
    <label class="toggle-container">
      <input type="checkbox" id="themeToggle" />
      <span class="toggle-slider">
        <span class="icon sun">☀︎</span>
        <span class="icon moon">☾</span>
        <span class="toggle-knob"></span>
      </span>
    </label>
  </div>

  <div class="content">
    <div id="dashboard" class="section active">
      <h1>Dashboard</h1>
  <div id="api-status" class="warning-message">
    Loading data from API...
  </div>

  <div class="card-container">
    <div class="card" id="users-card">
      <h3 id="total-users">0</h3>
      <p>Total Users</p>
    </div>
    <div class="card" id="exams-card">
      <h3 id="total-exams">0</h3>
      <p>Total Exams</p>
    </div>
    <div class="card" id="submissions-card">
      <h3 id="total-submissions">0</h3>
      <p>Total Submissions</p>
    </div>
  </div>

  <h1>Schedules</h1>
  <div id="schedules-empty" class="empty-state">
    Loading
  </div>
    <table id="schedules-table" style="display: none;">
      <thead><tr><th>Class Code</th><th>Class Name</th><th>Days</th><th>Location</th><th>Professor</th><th>Time</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

    <div id="users" class="section">
      <h1>Users</h1>
      <div id="users-empty" class="empty-state">
        Loading
      </div>
      <table id="users-table" style="display: none;">
        <thead><tr><th>User ID</th><th>Name</th><th>Email</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="exams" class="section">
      <h1>Exams</h1>
      <div id="exams-empty" class="empty-state">
        Loading
      </div>
      <table id="exams-table" style="display: none;">
        <thead><tr><th>Exam ID</th><th>Exam Title</th><th>Deadline</th><th>Status</th><th>User</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="submissions" class="section">
      <h1>Submissions</h1>
      <div id="submissions-empty" class="empty-state">
        Loading
      </div>
      <table id="submissions-table" style="display: none;">
        <thead><tr><th>Task ID</th><th>Submission Title</th><th>Deadline</th><th>Status</th><th>User ID</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'https://474qnu0tnc.execute-api.ap-southeast-2.amazonaws.com/test';

    const toggle = document.getElementById("themeToggle");
    const systemPrefersDark = window.matchMedia("(prefers-color-scheme: dark)");

    function applyTheme(isDark) {
      document.documentElement.setAttribute("data-theme", isDark ? "dark" : "light");
      toggle.checked = isDark;
    }

    const savedTheme = localStorage.getItem("theme");
    if(savedTheme === "dark") applyTheme(true);
    else if(savedTheme === "light") applyTheme(false);
    else applyTheme(systemPrefersDark.matches);

    toggle.addEventListener("change", () => {
      const isDark = toggle.checked;
      applyTheme(isDark);
      localStorage.setItem("theme", isDark ? "dark" : "light");
    });

    systemPrefersDark.addEventListener("change", e => {
      if(!localStorage.getItem("theme")) applyTheme(e.matches);
    });

    // Navigation
    function showSection(id, link) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
      if(link) link.classList.add('active');
      
      // Load data when switching sections
      if (id === 'dashboard') {
        loadDashboardData();
      } else if (id === 'users') {
        loadUsersData();
      } else if (id === 'exams') {
        loadExamsData();
      } else if (id === 'submissions') {
        loadSubmissionsData();
      }
    }

    async function fetchClassesData() {
      try {
        console.log('Fetching classes data...');

        const response = await fetch(`${API_BASE_URL}/admin/schedules`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Classes API response:', data);
        
        // Handle different response formats
        if (Array.isArray(data)) {
          return data;
        } else if (data.body) {
          const bodyData = JSON.parse(data.body);
          return Array.isArray(bodyData) ? bodyData : (bodyData.data || []);
        } else if (data.status === 'success' && data.data) {
          return data.data;
        }
        
        return data;
        
      } catch (error) {
        console.error('Error fetching classes:', error);
        return [];
      }
    }

    async function fetchCountData() {
      try {
        const response = await fetch(`${API_BASE_URL}/dashboard/overview`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        const bodyData = JSON.parse(data.body);        
        if (bodyData.status === 'success' && bodyData.data) {
          return bodyData.data;
        } else {
          throw new Error(bodyData.message || 'API returned error status');
        }
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }

    async function fetchUsersData() {
      try {
        const response = await fetch(`${API_BASE_URL}/admin/users`, {
          method: 'GET',  
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const responseText = await response.text();
        let data;
        if (responseText) {
          data = JSON.parse(responseText);
        } else {
          throw new Error('Empty response from server');
        }
        
        let users = [];
        
        if (Array.isArray(data)) {
          users = data;
        } else if (data.body) {
          const bodyData = JSON.parse(data.body);
          users = Array.isArray(bodyData) ? bodyData : (bodyData.data || [bodyData]);
        } else if (data.status === 'success' && data.data) {
          users = Array.isArray(data.data) ? data.data : [data.data];
        } else if (typeof data === 'object' && data !== null) {
          users = [data];
        }
        
        return users;
        
      } catch (error) {
        console.error('Error fetching users:', error);
        throw error;
      }
    }

    // ito kulangg 

    // exams
    async function fetchExamsData() {

      try {
        const response = await fetch(`${API_BASE_URL}/admin/exam`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const responseText = await response.text();
        let data;
        if (responseText) {
          data = JSON.parse(responseText);
        } else {
          throw new Error('Empty response from server');
        }

        let exams = [];

        if (Array.isArray(data)) {
          exams = data;
        } else if (data.body) {
          const bodyData = JSON.parse(data.body);
          exams = Array.isArray(bodyData) ? bodyData : (bodyData.data || [bodyData]);
        } else if (data.status === 'success' && data.data) {
          exams = Array.isArray(data.data) ? data.data : [data.data];
        } else if (typeof data === 'object' && data !== null) {
          exams = [data];
        }

        return exams;

      } catch (error) {
        console.error('Error fetching users:', error);
        throw error;
      }
    }


    // submissions
    async function fetchSubmissionsData() {
      try {
        const response = await fetch(`${API_BASE_URL}/admin/submission`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const responseText = await response.text();
        let data;
        if (responseText) {
          data = JSON.parse(responseText);
        } else {
          throw new Error('Empty response from server');
        }

        let submissions = [];

        if (Array.isArray(data)) {
          submissions = data;
        } else if (data.body) {
          const bodyData = JSON.parse(data.body);
          submissions = Array.isArray(bodyData) ? bodyData : (bodyData.data || [bodyData]);
        } else if (data.status === 'success' && data.data) {
          submissions = Array.isArray(data.data) ? data.data : [data.data];
        } else if (typeof data === 'object' && data !== null) {
          submissions = [data];
        }

        return submissions;

      } catch (error) {
        console.error('Error fetching users:', error);
        throw error;
      }
    }

    // Number animation
    function animateNumber(el, target) {
      let start = 0;
      const duration = 1000;
      const stepTime = Math.max(1, Math.floor(duration / target));
      const timer = setInterval(() => {
        start += 1;
        el.innerText = start;
        if(start >= target) clearInterval(timer);
      }, stepTime);
    }

    // Data loading functions
  async function loadDashboardData() {
    const cards = ['users-card', 'exams-card', 'submissions-card'];
    const statusElement = document.getElementById('api-status');
    
    cards.forEach(card => document.getElementById(card).classList.add('loading'));
    statusElement.textContent = 'Loading dashboard data...';
    statusElement.style.display = 'none';

    try {
      const countData = await fetchCountData();
      
      // Update counts with animation (removed total-classes)
      animateNumber(document.getElementById('total-users'), countData.total_users || 0);
      animateNumber(document.getElementById('total-exams'), countData.total_exams || 0);
      animateNumber(document.getElementById('total-submissions'), countData.total_submissions || 0);
      
      // Load schedules for dashboard
      await loadSchedules();
      
    } catch (error) {
      document.getElementById('total-users').textContent = '0';
      document.getElementById('total-exams').textContent = '0';
      document.getElementById('total-submissions').textContent = '0';
      // Removed total-classes error fallback
    } finally {
      cards.forEach(card => document.getElementById(card).classList.remove('loading'));
    }
  }

    async function loadSchedules() {
      const emptyElement = document.getElementById('schedules-empty');
      const tableElement = document.getElementById('schedules-table');
      
      try {
        const classesData = await fetchClassesData();
        if (classesData && classesData.length > 0) {
          populateSchedulesTable(classesData);
          emptyElement.style.display = 'none';
          tableElement.style.display = 'table';
        } else {
          emptyElement.style.display = 'block';
          tableElement.style.display = 'none';
        }
      } catch (error) {
        emptyElement.textContent = `Error loading schedules: ${error.message}`;
        emptyElement.style.display = 'block';
        tableElement.style.display = 'none';
      }
    }

    async function loadUsersData() {
      const emptyElement = document.getElementById('users-empty');
      const tableElement = document.getElementById('users-table');
      
      try {
        const usersData = await fetchUsersData();
        if (usersData && usersData.length > 0) {
          populateUsersTable(usersData);
          emptyElement.style.display = 'none';
          tableElement.style.display = 'table';
        } else {
          emptyElement.style.display = 'block';
          tableElement.style.display = 'none';
        }
      } catch (error) {
        emptyElement.textContent = `Error loading users: ${error.message}`;
        emptyElement.style.display = 'block';
        tableElement.style.display = 'none';
      }
    }

    async function loadExamsData() {
      const emptyElement = document.getElementById('exams-empty');
      const tableElement = document.getElementById('exams-table');
      
      try {
        const examsData = await fetchExamsData();
        if (examsData && examsData.length > 0) {
          populateExamsTable(examsData);
          emptyElement.style.display = 'none';
          tableElement.style.display = 'table';
        } else {
          emptyElement.style.display = 'block';
          tableElement.style.display = 'none';
        }
      } catch (error) {
        emptyElement.textContent = `Error loading exams: ${error.message}`;
        emptyElement.style.display = 'block';
        tableElement.style.display = 'none';
      }
    }

    async function loadSubmissionsData() {
      const emptyElement = document.getElementById('submissions-empty');
      const tableElement = document.getElementById('submissions-table');
      
      try {
        const submissionsData = await fetchSubmissionsData();
        if (submissionsData && submissionsData.length > 0) {
          populateSubmissionsTable(submissionsData);
          emptyElement.style.display = 'none';
          tableElement.style.display = 'table';
        } else {
          emptyElement.style.display = 'block';
          tableElement.style.display = 'none';
        }
      } catch (error) {
        emptyElement.textContent = `Error loading submissions: ${error.message}`;
        emptyElement.style.display = 'block';
        tableElement.style.display = 'none';
      }
    }

    // Table population functions
    function populateUsersTable(users) {
      const tbody = document.querySelector('#users-table tbody');
      tbody.innerHTML = '';
      
      users.forEach(user => {
        const userId = user.user_id || user.id || 'N/A';
        const name = user.name || `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Unknown';
        const email = user.email || 'No email';
        
        tbody.innerHTML += `
          <tr>
            <td>${userId}</td>
            <td>${name}</td>
            <td>${email}</td>
          </tr>
        `;
      });
    }

    function populateSchedulesTable(classes) {
      const tbody = document.querySelector('#schedules-table tbody');
      tbody.innerHTML = '';
      
      classes.forEach(cls => {
        const classCode = cls.class_code || cls.classCode || 'N/A';
        const className = cls.class_name || cls.className || 'Unknown Class';
        // const userId = cls.user_id || 'N/A';
        const days = cls.days_of_week || cls.daysOfWeek || [];
        const timeStart = cls.time_start || cls.timeStart || '';
        const timeEnd = cls.time_end || cls.timeEnd || '';
        const professor = cls.professor || 'Not specified';
        const location = cls.location || 'Not specified';
        
        // Format days as badges
        const daysHtml = Array.isArray(days) 
          ? days.map(day => `<span class="days-badge">${day}</span>`).join('')
          : '<span class="days-badge">Unknown</span>';
        
        // Format time
        const timeText = timeStart && timeEnd ? `${timeStart} – ${timeEnd}` : 'Not specified';
        
        tbody.innerHTML += `
          <tr>
            <td>${classCode}</td>
            <td>${className}</td>
            <td>${daysHtml}</td>
            <td>${location}</td>
            <td>${professor}</td>
            <td>${timeText}</td>
          </tr>
        `;
      });
    }

    function populateExamsTable(exams) {
      const tbody = document.querySelector('#exams-table tbody');
      tbody.innerHTML = '';
      exams.forEach(e => {
        tbody.innerHTML += `<tr><td>${e.exam_id}</td><td>${e.exam_title}</td><td>${e.deadline}</td><td>${e.status}</td><td>${e.user || e.user_id}</td></tr>`;
      });
    }

    function populateSubmissionsTable(submissions) {
      const tbody = document.querySelector('#submissions-table tbody');
      tbody.innerHTML = '';
      submissions.forEach(s => {
        tbody.innerHTML += `<tr><td>${s.task_id}</td><td>${s.Title}</td><td>${s.deadline}</td><td>${s.status}</td><td>${s.user_id}</td></tr>`;
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadDashboardData();
      document.querySelectorAll('.sidebar a')[0].classList.add('active');
    });
  </script>
</body>
</html>